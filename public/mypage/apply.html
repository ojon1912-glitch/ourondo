<!DOCTYPE html>
<!-- ★ VERSION v20251230_6 (신규 R2 업로드 파일 표시 고정: apply/... key → R2 public URL 변환) -->
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>지원자 관리 - 우리의 온도</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // ★ ADD(v20251230_6): 로컬/배포 자동 구분 + R2 public 도메인 세팅
    (function () {
      const host = location.hostname || "";
      const isProd = (host === "ourondo.com") || (host === "ourondo.fly.dev") || host.endsWith(".fly.dev");
      window.STORAGE_TYPE = isProd ? "r2" : "local";
      window.R2_PUBLIC_DOMAIN = "pub-2a82da3e11e64177a84a58a7c86a9cf0.r2.dev";
    })();
  </script>
</head>

<body class="bg-zinc-900 text-white">

<div id="header"></div>
<script src="/js/layout.js"></script>
<script>
  fetch("/components/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;
      initHeader();
      applyLoginState();
    });
</script>

<main class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold mb-6 text-gray-100">지원자 관리</h1>

  <!-- 검색 & 필터 -->
  <div class="bg-zinc-800 p-4 rounded-lg mb-6 flex flex-wrap gap-3 items-center">
    <input id="searchInput" type="text" placeholder="이름, 번호, MBTI 검색..."
      class="bg-zinc-700 text-white px-4 py-2 rounded flex-1 min-w-[200px] outline-none focus:ring-2 focus:ring-blue-500" />
    <select id="filterProduct" class="bg-zinc-700 text-white px-3 py-2 rounded outline-none">
      <option value="">전체 상품</option>
      <option value="1">Classic</option>
      <option value="2">Spark</option>
    </select>
    <select id="filterFlag" class="bg-zinc-700 text-white px-3 py-2 rounded outline-none">
      <option value="">전체 상태</option>
      <option value="AA">대기중</option>
      <option value="PS">수락됨</option>
      <option value="RJ">거절됨</option>
    </select>
    <select id="filterPay" class="bg-zinc-700 text-white px-3 py-2 rounded outline-none">
      <option value="">전체 결제</option>
      <option value="PA">결제완료</option>
      <option value="RR">환불요청</option>
      <option value="RF">환불완료</option>
    </select>
    <span id="resultCount" class="text-sm text-gray-400 ml-auto"></span>
  </div>

  <div id="applyList" class="space-y-4"></div>
</main>

<div id="footer"></div>
<script>
  fetch("/components/footer.html")
    .then(res => res.text())
    .then(html => (document.getElementById("footer").innerHTML = html));
</script>

<script>
function formatDateTime(dateStr) {
  return new Date(dateStr).toISOString().split("T")[0];
}

function productTypeText(type) {
  switch (Number(type)) {
    case 1: return "Classic";
    case 2: return "Spark";
    default: return "알 수 없음";
  }
}

function genderTypeText(type) {
  switch (type) {
    case 'M': return "남성";
    case 'F': return "여성";
    default: return "알 수 없음";
  }
}

function formatKST(datetime) {
  return new Date(datetime).toLocaleString("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  });
}


// ★ FIX: 이미지 경로 정규화
function resolveImageUrl(path) {
  if (!path) return "";

  // 이미 절대 URL (R2)
  if (path.startsWith("http")) {
    return path;
  }

  // 로컬 업로드 (/uploads/...) - 과거 데이터는 안 보여도 된다고 했지만, 로컬 개발은 유지
  if (path.startsWith("/uploads")) {
    return path;
  }

  // ★ CHANGED(v20251230_6): R2 key 형태 (apply/xxx.png) 는 무조건 R2 public URL로 변환
  if (path.startsWith("apply/") && window.STORAGE_TYPE === "r2" && window.R2_PUBLIC_DOMAIN) {
    return `https://${window.R2_PUBLIC_DOMAIN}/${path}`;
  }

  // fallback (로컬)
  return `/uploads/${path}`;
}


let allData = [];

(async function () {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("로그인이 필요합니다.");
    location.href = "/auth/login.html";
    return;
  }

  const res = await fetch("/api/admin/apply", {
    headers: { Authorization: `Bearer ${token}` }
  });

  allData = await res.json();
  renderList();

  // 검색 & 필터 이벤트
  document.getElementById("searchInput").addEventListener("input", renderList);
  document.getElementById("filterProduct").addEventListener("change", renderList);
  document.getElementById("filterFlag").addEventListener("change", renderList);
  document.getElementById("filterPay").addEventListener("change", renderList);
})();

function flagText(flag) {
  if (flag === "AA") return "대기중";
  if (flag === "PS") return "수락됨";
  if (flag === "RJ") return "거절됨";
  return flag || "-";
}

function flagBadge(flag) {
  const colors = {
    AA: "bg-yellow-500/20 text-yellow-400 border-yellow-500/40",
    PS: "bg-green-500/20 text-green-400 border-green-500/40",
    RJ: "bg-red-500/20 text-red-400 border-red-500/40",
  };
  const cls = colors[flag] || "bg-gray-500/20 text-gray-400 border-gray-500/40";
  return `<span class="px-2 py-0.5 rounded text-xs border ${cls}">${flagText(flag)}</span>`;
}

function payBadge(status) {
  if (!status || status === "RD") return "";
  const map = {
    PA: { text: "결제완료", cls: "bg-blue-500/20 text-blue-400 border-blue-500/40" },
    FA: { text: "결제실패", cls: "bg-red-500/20 text-red-400 border-red-500/40" },
    RR: { text: "환불요청", cls: "bg-orange-500/20 text-orange-400 border-orange-500/40" },
    RF: { text: "환불완료", cls: "bg-gray-500/20 text-gray-400 border-gray-500/40" },
  };
  const m = map[status] || { text: status, cls: "bg-gray-500/20 text-gray-400 border-gray-500/40" };
  return `<span class="px-2 py-0.5 rounded text-xs border ${m.cls}">${m.text}</span>`;
}

function refundBtn(item) {
  if (item.is_confirmed === 1) return "";
  if (item.pay_status === "PA")
    return `<button onclick="adminRefund(${item.apply_seq})" class="text-xs bg-blue-600 px-3 py-1 rounded hover:bg-blue-700">환불</button>`;
  if (item.pay_status === "RR")
    return `<button onclick="adminRefund(${item.apply_seq})" class="text-xs bg-red-600 px-3 py-1 rounded hover:bg-red-700 border border-red-400 animate-pulse">환불 처리</button>`;
  if (item.pay_status === "RF")
    return `<span class="text-xs bg-gray-600 px-3 py-1 rounded text-gray-400">환불 완료</span>`;
  return "";
}

function confirmBtn(item) {
  if (item.is_confirmed === 1) {
    return `<span class="px-2 py-0.5 rounded text-xs border bg-purple-500/20 text-purple-400 border-purple-500/40">참여확인됨</span>`;
  }
  if (item.flag === "PS" && item.pay_status === "PA") {
    return `<button onclick="confirmParticipation(${item.apply_seq})" class="text-xs bg-purple-600 px-3 py-1.5 rounded hover:bg-purple-700">참여확인</button>`;
  }
  return "";
}

function renderList() {
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  const fProduct = document.getElementById("filterProduct").value;
  const fFlag = document.getElementById("filterFlag").value;
  const fPay = document.getElementById("filterPay").value;
  const container = document.getElementById("applyList");

  const filtered = allData.filter(item => {
    if (fProduct && String(item.product_type) !== fProduct) return false;
    if (fFlag && item.flag !== fFlag) return false;
    if (fPay && item.pay_status !== fPay) return false;
    if (query) {
      const haystack = [item.name, item.contact, item.mbti, item.job, item.message].join(" ").toLowerCase();
      if (!haystack.includes(query)) return false;
    }
    return true;
  });

  document.getElementById("resultCount").textContent = `${filtered.length}건 / 전체 ${allData.length}건`;

  if (filtered.length === 0) {
    container.innerHTML = `<p class="text-gray-500 text-center py-8">조건에 맞는 지원자가 없습니다.</p>`;
    return;
  }

  container.innerHTML = filtered.map(item => `
    <div class="bg-zinc-800 rounded-lg overflow-hidden border border-zinc-700 hover:border-zinc-500 transition" data-expanded="false">
      <!-- 상단: 이름 + 뱃지 + 시간 (클릭으로 토글) -->
      <div class="flex items-center justify-between px-5 py-3 border-b border-zinc-700 bg-zinc-800/80 cursor-pointer select-none apply-header" onclick="toggleApplyCard(this)">
        <div class="flex items-center gap-3">
          <span class="text-gray-500 text-xs apply-arrow">▶</span>
          <h2 class="text-lg font-bold">${item.name}</h2>
          ${flagBadge(item.flag)}
          ${payBadge(item.pay_status)}
        </div>
        <span class="text-xs text-gray-500">${formatKST(item.cre_dtime)}</span>
      </div>

      <div class="px-5 py-4 apply-detail" style="display:none;">
        <!-- 정보 그리드 -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-6 gap-y-2 text-sm mb-4">
          <div><span class="text-gray-500">상품</span> <span class="ml-2">${productTypeText(item.product_type)}</span></div>
          <div><span class="text-gray-500">신청일</span> <span class="ml-2">${formatDateTime(item.apply_date)}</span></div>
          <div><span class="text-gray-500">성별</span> <span class="ml-2">${genderTypeText(item.gender)}</span></div>
          <div><span class="text-gray-500">출생</span> <span class="ml-2">${item.birth_year}년</span></div>
          <div><span class="text-gray-500">키</span> <span class="ml-2">${item.height}</span></div>
          <div><span class="text-gray-500">직업</span> <span class="ml-2">${item.job}</span></div>
          <div><span class="text-gray-500">MBTI</span> <span class="ml-2">${item.mbti}</span></div>
          <div><span class="text-gray-500">연락처</span> <span class="ml-2">${item.contact}</span></div>
        </div>

        ${item.message ? `<p class="text-sm text-gray-400 bg-zinc-900/50 rounded px-3 py-2 mb-4">${item.message}</p>` : ""}

        <!-- 사진 -->
        ${(item.photos || []).length > 0 ? `
        <div class="flex gap-3 mb-4 flex-wrap">
          ${item.photos.map(p => {
            const url = resolveImageUrl(p);
            return `<a href="${url}" target="_blank"><img src="${url}" class="w-24 h-32 object-cover rounded border border-zinc-600 hover:opacity-80 transition" /></a>`;
          }).join("")}
        </div>` : ""}

        <!-- 버튼 -->
        <div class="flex gap-2 items-center flex-wrap">
          <button onclick="approve(${item.apply_seq})" class="text-xs bg-green-600 px-3 py-1.5 rounded hover:bg-green-700">수락</button>
          <button onclick="reject(${item.apply_seq})" class="text-xs bg-red-600 px-3 py-1.5 rounded hover:bg-red-700">거절</button>
          ${refundBtn(item)}
          ${confirmBtn(item)}
        </div>
      </div>
    </div>
  `).join("");
}

function toggleApplyCard(headerEl) {
  const card = headerEl.closest('[data-expanded]');
  const detail = card.querySelector('.apply-detail');
  const arrow = card.querySelector('.apply-arrow');
  const expanded = card.dataset.expanded === 'true';
  card.dataset.expanded = expanded ? 'false' : 'true';
  detail.style.display = expanded ? 'none' : 'block';
  arrow.textContent = expanded ? '▶' : '▼';
}

function approve(id) {
  if (!confirm("이 지원자를 수락하시겠습니까?")) return;
  fetch(`/api/admin/apply/${id}/approve`, {
    method: "POST",
    headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
  }).then(() => location.reload());
}

function reject(id) {
  if (!confirm("이 지원자를 거절하시겠습니까?")) return;
  fetch(`/api/admin/apply/${id}/reject`, {
    method: "POST",
    headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
  }).then(() => location.reload());
}

function confirmParticipation(id) {
  if (!confirm("참여확정 하시겠습니까?\n\n확정 후에는 환불이 불가능합니다.")) return;
  fetch(`/api/admin/apply/${id}/confirm`, {
    method: "POST",
    headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert("참여확인이 완료되었습니다.");
      location.reload();
    } else {
      alert(data.error || "참여확인에 실패했습니다.");
    }
  })
  .catch(() => alert("오류가 발생했습니다."));
}

async function adminRefund(id) {
  if (!confirm("환불 처리하시겠습니까?\n\n이니시스 취소 API가 호출되며, 이 작업은 되돌릴 수 없습니다.")) return;
  const btn = event.target;
  const origText = btn.textContent;
  btn.textContent = "처리중...";
  btn.disabled = true;
  try {
    const res = await fetch(`/api/admin/apply/${id}/refund`, {
      method: "POST",
      headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
    });
    const data = await res.json();
    if (data.success) {
      alert("환불 처리가 완료되었습니다.");
      location.reload();
    } else {
      alert(data.error || "환불 처리에 실패했습니다.");
      btn.textContent = origText;
      btn.disabled = false;
    }
  } catch (e) {
    alert("오류가 발생했습니다.");
    btn.textContent = origText;
    btn.disabled = false;
  }
}
</script>

<script>
  window.BODY_LAYOUT = {
    theme: "dark",
    bokeh: true
  };
</script>
<script src="/js/bodylayout.js"></script>

</body>
</html>
