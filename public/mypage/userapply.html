<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚´ ì§€ì› ë‚´ì—­ - ìš°ë¦¬ì˜ ì˜¨ë„</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white">

<div id="header"></div>
<script src="/js/layout.js"></script>
<script>
  fetch("/components/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;
      initHeader();
      applyLoginState();
    });
</script>

<main class="max-w-3xl mx-auto px-1 py-10">
  <h1 class="text-3xl font-bold mb-8 text-gray-100">ğŸ“„ ë‚´ ì§€ì› ë‚´ì—­</h1>

  <div id="applyList" class="space-y-4"></div>
</main>

<script>
(async function () {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    location.href = "/auth/login.html";
    return;
  }

  const res = await fetch("/api/mypage/apply", {
    headers: { Authorization: `Bearer ${token}` }
  });

  const data = await res.json();
  const list = document.getElementById("applyList");

  if (data.length === 0) {
    list.innerHTML = `<p class="text-gray-100">ì•„ì§ ì§€ì›í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  data.forEach(item => {
    const div = document.createElement("div");
    div.className = "bg-zinc-800 p-4 rounded-lg";

    let payBtnHtml = "";
    if (item.pay_status === "PA") {
      payBtnHtml = `<button onclick="requestRefund(${item.apply_seq})"
        class="ml-2 px-3 py-1 rounded bg-orange-500 text-white text-sm hover:bg-orange-600">í™˜ë¶ˆ ì‹ ì²­</button>`;
    } else if (item.pay_status === "RR") {
      payBtnHtml = `<span class="ml-2 px-3 py-1 rounded bg-yellow-500 text-black text-sm">í™˜ë¶ˆ ì²˜ë¦¬ì¤‘</span>`;
    } else if (item.pay_status === "RF") {
      payBtnHtml = `<span class="ml-2 px-3 py-1 rounded bg-gray-500 text-white text-sm">í™˜ë¶ˆ ì™„ë£Œ</span>`;
    }

    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p class="font-bold">${productTypeText(item.product_type)}</p>
          <p class="text-sm text-gray-100">
            ì‹ ì²­ì¼: ${formatDate(item.apply_date)}
          </p>
        </div>
        <div class="flex items-center">
          <span class="px-3 py-1 rounded ${statusColor(item.flag)}">
            ${statusText(item.flag)}
          </span>
          ${payBtnHtml}
        </div>
      </div>
    `;

    list.appendChild(div);
  });
})();

function productTypeText(type) {
  if (type === 1) return "Classic";
  if (type === 2) return "Spark";
  return "ì•Œ ìˆ˜ ì—†ìŒ";
}

function statusText(flag) {
  if (flag === "AA") return "ëŒ€ê¸°ì¤‘";
  if (flag === "PS") return "ìˆ˜ë½ë¨";
  if (flag === "RJ") return "ê±°ì ˆë¨";
  return flag;
}

function statusColor(flag) {
  if (flag === "AA") return "bg-yellow-500 text-black";
  if (flag === "PS") return "bg-green-600";
  if (flag === "RJ") return "bg-red-600";
  return "bg-gray-500";
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
}

async function requestRefund(applySeq) {
  if (!confirm("í™˜ë¶ˆì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const token = localStorage.getItem("token");
  try {
    const res = await fetch(`/api/mypage/apply/${applySeq}/refund`, {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    if (data.success) {
      alert("í™˜ë¶ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } else {
      alert(data.error || "í™˜ë¶ˆ ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (e) {
    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}
</script>


<!-- Footer -->
<div id="footer"></div>
<script>
  fetch("/components/footer.html")
    .then(res => res.text())
    .then(html => (document.getElementById("footer").innerHTML = html));
</script>

<!-- ================= ëª¨ë‹¬ ================= -->
<script src="/js/privacy-modal.js"></script>

<!-- body ì„¤ì • -->
  <script>
    window.BODY_LAYOUT = {
      theme: "dark",
      bokeh: true
    };
  </script>
  <script src="/js/bodylayout.js"></script>
  

</body>
</html>
