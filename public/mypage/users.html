<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사용자 관리 - 우리의 온도</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-zinc-900 text-white">

<div id="header"></div>
<script src="/js/layout.js"></script>
<script>
  fetch("/components/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;
      initHeader();
      applyLoginState();
    });
</script>

<main class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold mb-6 text-gray-100">사용자 관리</h1>

  <!-- 검색 & 필터 -->
  <div class="bg-zinc-800 p-4 rounded-lg mb-6 flex flex-wrap gap-3 items-center">
    <input id="searchInput" type="text" placeholder="이름, 아이디, 전화번호 검색..."
      class="bg-zinc-700 text-white px-4 py-2 rounded flex-1 min-w-[200px] outline-none focus:ring-2 focus:ring-emerald-500" />
    <select id="filterFlag" class="bg-zinc-700 text-white px-3 py-2 rounded outline-none">
      <option value="">전체 상태</option>
      <option value="AA">활성 (AA)</option>
      <option value="WT">대기 (WT)</option>
      <option value="DD">삭제 (DD)</option>
    </select>
    <span id="resultCount" class="text-sm text-gray-400 ml-auto"></span>
  </div>

  <div id="userList" class="space-y-4"></div>
</main>

<div id="footer"></div>
<script>
  fetch("/components/footer.html")
    .then(res => res.text())
    .then(html => (document.getElementById("footer").innerHTML = html));
</script>

<!-- 적립금 부여/차감 모달 -->
<div id="pointModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
  <div class="bg-zinc-800 rounded-lg p-6 w-full max-w-md mx-4">
    <h3 id="pointModalTitle" class="text-lg font-bold mb-4">적립금 부여</h3>
    <p id="pointModalTarget" class="text-gray-400 text-sm mb-4"></p>
    <div class="flex gap-3 mb-4">
      <label class="flex items-center gap-2 cursor-pointer">
        <input type="radio" name="pointType" value="earn" checked class="accent-blue-500" onchange="updatePointModalType()" />
        <span class="text-sm">부여</span>
      </label>
      <label class="flex items-center gap-2 cursor-pointer">
        <input type="radio" name="pointType" value="deduct" class="accent-red-500" onchange="updatePointModalType()" />
        <span class="text-sm">차감</span>
      </label>
    </div>
    <input id="pointAmount" type="number" min="1" max="100000" placeholder="금액 (원)"
      class="w-full bg-zinc-700 text-white px-4 py-2 rounded mb-3 outline-none focus:ring-2 focus:ring-blue-500" />
    <input id="pointDesc" type="text" placeholder="사유 (선택)"
      class="w-full bg-zinc-700 text-white px-4 py-2 rounded mb-4 outline-none focus:ring-2 focus:ring-blue-500" />
    <div class="flex gap-3 justify-end">
      <button onclick="closePointModal()" class="px-4 py-2 bg-zinc-600 rounded hover:bg-zinc-500">취소</button>
      <button id="pointSubmitBtn" onclick="submitPoint()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">부여</button>
    </div>
  </div>
</div>

<script>
function formatKST(datetime) {
  if (!datetime) return "-";
  return new Date(datetime).toLocaleString("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit"
  });
}

function userFlagText(flag) {
  if (flag === "AA") return "활성";
  if (flag === "WT") return "대기";
  if (flag === "DD") return "삭제";
  return flag || "-";
}

function userFlagBadge(flag) {
  const colors = {
    AA: "bg-green-500/20 text-green-400 border-green-500/40",
    WT: "bg-yellow-500/20 text-yellow-400 border-yellow-500/40",
    DD: "bg-red-500/20 text-red-400 border-red-500/40",
  };
  const cls = colors[flag] || "bg-gray-500/20 text-gray-400 border-gray-500/40";
  return `<span class="px-2 py-0.5 rounded text-xs border ${cls}">${userFlagText(flag)}</span>`;
}

function loginTypeBadge(type) {
  if (type === "KAKAO") return `<span class="px-2 py-0.5 rounded text-xs border bg-yellow-500/20 text-yellow-300 border-yellow-500/40">카카오</span>`;
  return `<span class="px-2 py-0.5 rounded text-xs border bg-zinc-500/20 text-zinc-400 border-zinc-500/40">로컬</span>`;
}

function genderText(g) {
  if (g === "M") return "남성";
  if (g === "F") return "여성";
  return g || "-";
}

function flagButtons(user) {
  if (user.user_seq === currentUserSeq) return `<span class="text-xs text-gray-500">본인 계정</span>`;
  const btns = [];
  if (user.flag !== "AA") btns.push(`<button onclick="changeFlag(${user.user_seq}, 'AA')" class="text-xs bg-green-600 px-3 py-1.5 rounded hover:bg-green-700 min-h-[36px]">활성화</button>`);
  if (user.flag !== "DD") btns.push(`<button onclick="changeFlag(${user.user_seq}, 'DD')" class="text-xs bg-red-600 px-3 py-1.5 rounded hover:bg-red-700 min-h-[36px]">삭제</button>`);
  btns.push(`<button onclick="openPointModal(${user.user_seq}, '${(user.user_name || "").replace(/'/g, "\\'")}')" class="text-xs bg-blue-600 px-3 py-1.5 rounded hover:bg-blue-700 min-h-[36px]">적립금 부여</button>`);
  btns.push(`<button onclick="openPointModal(${user.user_seq}, '${(user.user_name || "").replace(/'/g, "\\'")}', 'deduct')" class="text-xs bg-orange-600 px-3 py-1.5 rounded hover:bg-orange-700 min-h-[36px]">적립금 차감</button>`);
  return btns.join("\n");
}

let allData = [];
let currentUserSeq = null;

(async function () {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("로그인이 필요합니다.");
    location.href = "/auth/login.html";
    return;
  }

  try {
    const meRes = await fetch("/api/auth/me", {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!meRes.ok) throw new Error("인증 실패");
    const me = await meRes.json();

    if (me.is_admin !== 1) {
      alert("관리자 전용 페이지입니다.");
      location.href = "/mypage/index.html";
      return;
    }
    currentUserSeq = me.user_seq;

    const res = await fetch("/api/admin/users", {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("조회 실패");
    allData = await res.json();
    renderList();

    document.getElementById("searchInput").addEventListener("input", renderList);
    document.getElementById("filterFlag").addEventListener("change", renderList);
  } catch (err) {
    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
    localStorage.removeItem("token");
    location.href = "/auth/login.html";
  }
})();

function renderList() {
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  const fFlag = document.getElementById("filterFlag").value;
  const container = document.getElementById("userList");

  const filtered = allData.filter(item => {
    if (fFlag && item.flag !== fFlag) return false;
    if (query) {
      const haystack = [item.user_id, item.user_name, item.name, item.phone].join(" ").toLowerCase();
      if (!haystack.includes(query)) return false;
    }
    return true;
  });

  document.getElementById("resultCount").textContent = `${filtered.length}명 / 전체 ${allData.length}명`;

  if (filtered.length === 0) {
    container.innerHTML = `<p class="text-gray-500 text-center py-8">조건에 맞는 사용자가 없습니다.</p>`;
    return;
  }

  container.innerHTML = filtered.map(user => `
    <div class="bg-zinc-800 rounded-lg overflow-hidden border border-zinc-700 hover:border-zinc-500 transition">
      <div class="flex items-center justify-between px-5 py-3 border-b border-zinc-700 bg-zinc-800/80">
        <div class="flex items-center gap-3 flex-wrap">
          <h2 class="text-lg font-bold">${user.user_name || "-"}</h2>
          ${userFlagBadge(user.flag)}
          ${loginTypeBadge(user.login_type)}
          ${user.is_admin === 1 ? `<span class="px-2 py-0.5 rounded text-xs border bg-purple-500/20 text-purple-400 border-purple-500/40">관리자</span>` : ""}
        </div>
        <span class="text-xs text-gray-500 shrink-0 ml-2">${formatKST(user.cre_dtime)}</span>
      </div>

      <div class="px-5 py-4">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-6 gap-y-2 text-sm mb-4">
          <div><span class="text-gray-500">아이디</span> <span class="ml-2">${user.user_id}</span></div>
          <div><span class="text-gray-500">이름</span> <span class="ml-2">${user.name || "-"}</span></div>
          <div><span class="text-gray-500">전화번호</span> <span class="ml-2">${user.phone || "-"}</span></div>
          <div><span class="text-gray-500">성별</span> <span class="ml-2">${genderText(user.gender)}</span></div>
          <div><span class="text-gray-500">출생연도</span> <span class="ml-2">${user.birth_year || "-"}</span></div>
          <div><span class="text-gray-500">로그인</span> <span class="ml-2">${user.login_type || "LOCAL"}</span></div>
          <div><span class="text-gray-500">적립금</span> <span class="ml-2 text-green-400 font-bold">${(user.point_balance || 0).toLocaleString()}원</span></div>
        </div>

        <div class="flex gap-2 items-center flex-wrap">
          ${flagButtons(user)}
        </div>
      </div>
    </div>
  `).join("");
}

async function changeFlag(userSeq, newFlag) {
  const flagNames = { AA: "활성화", DD: "삭제" };
  if (!confirm(`이 사용자를 "${flagNames[newFlag]}" 상태로 변경하시겠습니까?`)) return;

  if (newFlag === "DD") {
    if (!confirm("정말로 이 사용자를 삭제하시겠습니까?\n\n삭제된 사용자는 로그인이 불가능해집니다.")) return;
  }

  const token = localStorage.getItem("token");
  try {
    const res = await fetch(`/api/admin/user/${userSeq}/flag`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ flag: newFlag })
    });
    const data = await res.json();
    if (data.success) {
      alert("상태가 변경되었습니다.");
      location.reload();
    } else {
      alert(data.error || "변경 실패");
    }
  } catch (e) {
    alert("오류가 발생했습니다.");
  }
}

// 적립금 모달
let pointTargetSeq = null;

function openPointModal(userSeq, userName, type) {
  pointTargetSeq = userSeq;
  document.getElementById("pointModalTarget").textContent = `대상: ${userName} (seq: ${userSeq})`;
  document.getElementById("pointAmount").value = "";
  document.getElementById("pointDesc").value = "";
  // 타입 설정
  const radios = document.querySelectorAll('input[name="pointType"]');
  radios.forEach(r => r.checked = (r.value === (type || 'earn')));
  updatePointModalType();
  document.getElementById("pointModal").classList.remove("hidden");
}

function updatePointModalType() {
  const isDeduct = document.querySelector('input[name="pointType"]:checked').value === 'deduct';
  document.getElementById("pointModalTitle").textContent = isDeduct ? '적립금 차감' : '적립금 부여';
  const btn = document.getElementById("pointSubmitBtn");
  btn.textContent = isDeduct ? '차감' : '부여';
  btn.className = isDeduct
    ? 'px-4 py-2 bg-orange-600 rounded hover:bg-orange-700'
    : 'px-4 py-2 bg-blue-600 rounded hover:bg-blue-700';
}

function closePointModal() {
  document.getElementById("pointModal").classList.add("hidden");
  pointTargetSeq = null;
}

async function submitPoint() {
  const amount = parseInt(document.getElementById("pointAmount").value);
  const description = document.getElementById("pointDesc").value.trim();
  const isDeduct = document.querySelector('input[name="pointType"]:checked').value === 'deduct';

  if (!amount || amount <= 0) {
    alert("유효한 금액을 입력해주세요.");
    return;
  }
  if (amount > 100000) {
    alert(`1회 최대 100,000원까지 ${isDeduct ? '차감' : '부여'}할 수 있습니다.`);
    return;
  }

  const token = localStorage.getItem("token");
  try {
    const bodyData = isDeduct
      ? { amount: -amount, description: description || "관리자 직접 차감" }
      : { amount, description };

    const res = await fetch(`/api/admin/user/${pointTargetSeq}/point`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(bodyData)
    });
    const data = await res.json();
    if (data.success) {
      alert(`적립금이 ${isDeduct ? '차감' : '부여'}되었습니다.\n잔액: ${data.newBalance.toLocaleString()}원`);
      closePointModal();
      location.reload();
    } else {
      alert(data.error || `적립금 ${isDeduct ? '차감' : '부여'} 실패`);
    }
  } catch (e) {
    alert("오류가 발생했습니다.");
  }
}
</script>

<script>
  window.BODY_LAYOUT = {
    theme: "dark",
    bokeh: true
  };
</script>
<script src="/js/bodylayout.js"></script>

</body>
</html>
