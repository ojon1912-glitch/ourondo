<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>비밀번호 변경 - 우리의 온도</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">

<!-- Header -->
<div id="header"></div>
<script src="/js/layout.js"></script>
<script>
  fetch("/components/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;
      initHeader();
      applyLoginState();
    });
</script>

<main class="max-w-md mx-auto px-1 py-10">
  <h1 class="text-2xl font-bold mb-6">비밀번호 변경</h1>

  <div class="space-y-4 bg-white p-6 rounded shadow">

    <div>
      <label class="block mb-1 text-gray-700">현재 비밀번호</label>
      <input
        id="current_pw"
        type="password"
        class="w-full border rounded px-3 py-2"
        placeholder="현재 비밀번호를 입력하세요"
      />
    </div>

    <div>
      <label class="block mb-1 text-gray-700">새 비밀번호</label>
      <input
        id="new_pw"
        type="password"
        class="w-full border rounded px-3 py-2"
        placeholder="새 비밀번호를 입력하세요"
      />
    </div>

    <div>
      <label class="block mb-1 text-gray-700">새 비밀번호 확인</label>
      <input
        id="new_pw_confirm"
        type="password"
        class="w-full border rounded px-3 py-2"
        placeholder="새 비밀번호를 한번 더 입력하세요"
      />
    </div>

    <button
      id="changePwBtn"
      class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600"
    >
      비밀번호 변경
    </button>

  </div>
</main>

<!-- Footer -->
<div id="footer"></div>
<script>
  fetch("/components/footer.html")
    .then(res => res.text())
    .then(html => document.getElementById("footer").innerHTML = html);
</script>
<!-- ================= 모달 ================= -->
<script src="/js/privacy-modal.js"></script>

<script>
  // 비밀번호 변경 버튼 이벤트
  document.getElementById("changePwBtn").addEventListener("click", async () => {
    const current_pw = document.getElementById("current_pw").value.trim();
    const new_pw = document.getElementById("new_pw").value.trim();
    const new_pw_confirm = document.getElementById("new_pw_confirm").value.trim();

    if (!current_pw || !new_pw || !new_pw_confirm) {
      alert("모든 항목을 입력해주세요.");
      return;
    }

    if (new_pw !== new_pw_confirm) {
      alert("새 비밀번호가 서로 일치하지 않습니다.");
      return;
    }

    const token = localStorage.getItem("token");
    if (!token) {
      alert("로그인이 필요합니다.");
      location.href = "/auth/login.html";
      return;
    }

    try {
      const res = await fetch("/api/auth/password", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ current_pw, new_pw }),
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "비밀번호 변경에 실패했습니다.");
        return;
      }

      alert("비밀번호가 변경되었습니다. 다시 로그인해주세요.");

      // 보안을 위해 토큰/유저정보 삭제 후 로그인 페이지로 이동
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      location.href = "/auth/login.html";

    } catch (err) {
      console.error(err);
      alert("서버 오류가 발생했습니다.");
    }
  });
</script>

<!-- body 설정 -->
  <script>
    window.BODY_LAYOUT = {
      theme: "dark",
      bokeh: true
    };
  </script>
  <script src="/js/bodylayout.js"></script>
</body>
</html>
