<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>심쿵게이지</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0f0a1a; color:#fff; font-family:'Pretendard','Apple SD Gothic Neo',sans-serif; min-height:100vh; overflow-x:hidden; }
    .game-bg { background: linear-gradient(135deg, #0f0a1a 0%, #1a0a2e 50%, #0f0a1a 100%); min-height:100vh; }
    .glow-pink { box-shadow: 0 0 20px rgba(236,72,153,0.3); }
    .glow-text { text-shadow: 0 0 10px rgba(236,72,153,0.5); }
    .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; }
    .btn-primary { background: linear-gradient(135deg, #ec4899, #a855f7); border:none; color:#fff; font-weight:700; border-radius:12px; padding:14px 24px; cursor:pointer; transition:all 0.2s; min-height:48px; }
    .btn-primary:hover { transform:scale(1.03); box-shadow:0 0 20px rgba(236,72,153,0.4); }
    .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-secondary { background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; font-weight:600; border-radius:12px; padding:14px 20px; cursor:pointer; transition:all 0.2s; min-height:48px; }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); border:none; color:#fff; font-weight:700; border-radius:12px; padding:12px 20px; cursor:pointer; min-height:44px; }
    .step-badge { display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700; }
    .step-active { background: rgba(236,72,153,0.3); color:#f9a8d4; border:1px solid rgba(236,72,153,0.5); }
    .step-idle { background: rgba(255,255,255,0.05); color:#888; border:1px solid rgba(255,255,255,0.1); }
    .member-card { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:12px 16px; }
    .admin-panel { background: rgba(99,102,241,0.1); border:1px solid rgba(99,102,241,0.3); border-radius:16px; padding:16px; }
    .pulse { animation: pulse-glow 2s infinite; }
    @keyframes pulse-glow { 0%,100%{ opacity:0.6; } 50%{ opacity:1; } }
    .top-bar { background: rgba(0,0,0,0.4); backdrop-filter:blur(20px); border-bottom:1px solid rgba(255,255,255,0.08); }
    #stepContent { min-height: 50vh; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
  </style>
</head>
<body class="game-bg">

<!-- 상단 바 -->
<div class="top-bar sticky top-0 z-50 px-4 py-3">
  <div class="max-w-lg mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="text-xl font-black glow-text">심쿵게이지</span>
      <span id="roomTitleBar" class="text-sm text-gray-400 truncate max-w-[140px]"></span>
    </div>
    <div class="flex items-center gap-2">
      <span id="stepBadge" class="step-badge step-active text-xs"></span>
      <button id="leaveBtn" class="text-xs text-gray-500 hover:text-gray-300 ml-2">나가기</button>
    </div>
  </div>
</div>

<!-- 관리자 컨트롤 (접이식) -->
<div id="adminBar" class="hidden">
  <div class="max-w-lg mx-auto px-4 py-2">
    <button id="toggleAdminPanel" class="text-xs text-indigo-400 hover:text-indigo-300 w-full text-left">
      관리자 패널 열기/닫기
    </button>
    <div id="adminPanel" class="admin-panel mt-2 hidden">
      <div class="flex items-center gap-2 mb-3">
        <label class="text-xs text-gray-400">테이블 수</label>
        <input id="tableCountInput" type="number" min="1" max="10" value="3"
          class="w-16 p-1 rounded bg-black/30 border border-white/10 text-center text-sm" />
        <button id="setTableCountBtn" class="text-xs bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded">설정</button>
      </div>
      <div class="flex flex-wrap gap-1 mb-3" id="stepButtons">
        <!-- 동적 생성 -->
      </div>
      <button id="closeRoomBtn" class="btn-danger text-xs px-3 py-1">방 종료</button>
    </div>
  </div>
</div>

<!-- 참여자 표시 (접이식) -->
<div class="max-w-lg mx-auto px-4 mt-3">
  <button id="toggleMembers" class="text-xs text-gray-500 hover:text-gray-300 mb-2">
    참여자 (<span id="memberCount">0</span>명) 보기/숨기기
  </button>
  <div id="memberList" class="hidden space-y-1 mb-4"></div>
</div>

<!-- 메인 게임 콘텐츠 -->
<div class="max-w-lg mx-auto px-4 py-4">
  <div id="stepContent" class="fade-in">
    <div class="text-center py-20">
      <div class="text-2xl pulse">로딩 중...</div>
    </div>
  </div>
</div>

<script>
(function() {
  var token = localStorage.getItem("token");
  if (!token) { alert("로그인이 필요합니다."); location.href = "/auth/login.html"; return; }

  var params = new URLSearchParams(location.search);
  var roomId = params.get("room");
  if (!roomId) { location.href = "/mypage/gauge.html"; return; }

  var headers = { Authorization: "Bearer " + token, "Content-Type": "application/json" };
  var currentUser = null;
  var isAdmin = false;
  var pollTimer = null;
  var lastStep = null;

  function parseJWT(t) { try { return JSON.parse(atob(t.split(".")[1])); } catch(e) { return null; } }
  currentUser = parseJWT(token);
  isAdmin = currentUser && currentUser.is_admin === 1;

  var STEPS = ["LOBBY","TABLE_SELECT","NAMING_IMAGE","NICKNAME","GAME1_1","GAME1_2","TALK1","HIDDEN1","GAME2_1","GAME2_2","GAME2_3","TALK2","HIDDEN2","GAME3_1","GAME3_2","GAME3_3","GAME3_4","TALK3","HIDDEN3","FINAL1","FINAL2","FINAL3","FINAL4"];

  // 관리자 UI
  if (isAdmin) {
    document.getElementById("adminBar").classList.remove("hidden");
    var stepBtns = document.getElementById("stepButtons");
    stepBtns.innerHTML = STEPS.map(function(s) {
      var label = s.replace("_"," ");
      return '<button data-step="' + s + '" class="step-btn text-xs px-3 py-2 rounded-lg border border-white/10 hover:border-pink-400 hover:text-pink-300 text-gray-500 transition min-h-[36px]">' + label + '</button>';
    }).join("");

    document.getElementById("toggleAdminPanel").addEventListener("click", function() {
      document.getElementById("adminPanel").classList.toggle("hidden");
    });

    stepBtns.addEventListener("click", async function(e) {
      var btn = e.target.closest("[data-step]");
      if (!btn) return;
      if (!confirm("'" + btn.dataset.step + "' 단계로 전환하시겠습니까?")) return;
      await fetch("/api/gauge/room/" + roomId + "/step", {
        method: "POST", headers: headers,
        body: JSON.stringify({ step: btn.dataset.step })
      });
      pollRoom();
    });

    document.getElementById("setTableCountBtn").addEventListener("click", async function() {
      var count = Number(document.getElementById("tableCountInput").value);
      if (!count || count < 1) return alert("유효한 수를 입력해주세요.");
      await fetch("/api/gauge/room/" + roomId + "/table-count", {
        method: "POST", headers: headers, body: JSON.stringify({ count: count })
      });
      pollRoom();
    });

    document.getElementById("closeRoomBtn").addEventListener("click", async function() {
      if (!confirm("이 방을 종료하시겠습니까?")) return;
      await fetch("/api/gauge/room/" + roomId + "/close", { method: "POST", headers: headers });
      location.href = "/mypage/gauge.html";
    });
  }

  document.getElementById("toggleMembers").addEventListener("click", function() {
    document.getElementById("memberList").classList.toggle("hidden");
  });

  // 나가기
  document.getElementById("leaveBtn").addEventListener("click", async function() {
    if (!confirm("방에서 나가시겠습니까?")) return;
    if (!isAdmin) {
      await fetch("/api/gauge/room/" + roomId + "/leave", { method: "POST", headers: headers }).catch(function(){});
    }
    location.href = "/mypage/gauge.html";
  });

  // 입장 처리
  async function initRoom() {
    if (isAdmin) { startPolling(); return; }
    try {
      var res = await fetch("/api/gauge/room/" + roomId, { headers: headers });
      var data = await res.json();
      if (data.myMember) { startPolling(); return; }
      // 입장 정보 입력 (인라인 폼)
      showJoinForm();
    } catch(e) { alert("서버 오류"); location.href = "/mypage/gauge.html"; }
  }

  function showJoinForm() {
    var el = document.getElementById("stepContent");
    el.innerHTML = '<div class="fade-in text-center">'
      + '<div class="text-3xl font-bold mb-2 glow-text">심쿵게이지</div>'
      + '<p class="text-gray-400 mb-8">입장 정보를 입력해주세요</p>'
      + '<div class="card p-6 text-left max-w-sm mx-auto">'
      + '<label class="text-sm text-gray-400 block mb-2">이름</label>'
      + '<input id="joinName" type="text" placeholder="이름을 입력해주세요"'
      + ' class="w-full p-3 rounded-xl bg-black/30 border border-white/10 text-white focus:border-pink-400 focus:outline-none mb-5" />'
      + '<label class="text-sm text-gray-400 block mb-2">성별</label>'
      + '<div class="flex gap-3 mb-6">'
      + '<button type="button" onclick="window._selectGender(this,\'M\')" class="flex-1 p-3 rounded-xl border border-white/10 bg-black/20 text-gray-400 text-center font-bold transition gender-btn">남성</button>'
      + '<button type="button" onclick="window._selectGender(this,\'F\')" class="flex-1 p-3 rounded-xl border border-white/10 bg-black/20 text-gray-400 text-center font-bold transition gender-btn">여성</button>'
      + '</div>'
      + '<input type="hidden" id="joinGender" value="" />'
      + '<button onclick="window._submitJoin()" class="btn-primary w-full text-lg">입장하기</button>'
      + '</div></div>';
  }

  window._selectGender = function(btn, val) {
    document.getElementById("joinGender").value = val;
    document.querySelectorAll(".gender-btn").forEach(function(b) {
      b.className = "flex-1 p-3 rounded-xl border border-white/10 bg-black/20 text-gray-400 text-center font-bold transition gender-btn";
    });
    if (val === "M") {
      btn.className = "flex-1 p-3 rounded-xl border border-blue-400 bg-blue-500/20 text-blue-400 text-center font-bold transition gender-btn";
    } else {
      btn.className = "flex-1 p-3 rounded-xl border border-pink-400 bg-pink-500/20 text-pink-400 text-center font-bold transition gender-btn";
    }
  };

  window._submitJoin = async function() {
    var name = document.getElementById("joinName").value.trim();
    var gender = document.getElementById("joinGender").value;
    if (!name) return alert("이름을 입력해주세요.");
    if (!gender) return alert("성별을 선택해주세요.");
    try {
      var res2 = await fetch("/api/gauge/room/" + roomId + "/join", {
        method: "POST", headers: headers,
        body: JSON.stringify({ name: name, gender: gender })
      });
      if (!res2.ok) { var d = await res2.json(); alert(d.error || "입장 실패"); return; }
      startPolling();
    } catch(e) { alert("서버 오류"); }
  };

  function startPolling() {
    pollRoom();
    pollTimer = setInterval(pollRoom, 3000);
  }

  async function pollRoom() {
    try {
      var res = await fetch("/api/gauge/room/" + roomId, { headers: headers });
      if (!res.ok) return;
      var data = await res.json();
      renderRoom(data);
    } catch(e) { console.error("poll error:", e); }
  }

  function esc(str) {
    if (!str) return "";
    return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function renderRoom(data) {
    var room = data.room;
    var members = data.members;
    var myMember = data.myMember;

    if (room.status === "CLOSED") {
      document.getElementById("stepContent").innerHTML = '<div class="text-center py-20"><div class="text-2xl mb-4">방이 종료되었습니다</div><button onclick="location.href=\'/mypage/gauge.html\'" class="btn-primary">로비로 돌아가기</button></div>';
      if (pollTimer) clearInterval(pollTimer);
      return;
    }

    // 거절된 사용자 감지 (폴링 중 myMember가 null이 되면 거절된 것)
    if (!isAdmin && !myMember && lastStep !== null) {
      if (pollTimer) clearInterval(pollTimer);
      document.getElementById("stepContent").innerHTML = '<div class="text-center py-20 fade-in"><div class="text-2xl mb-4">참여가 거절되었습니다</div><p class="text-gray-400 mb-6">호스트에 의해 방에서 제외되었습니다.</p><button onclick="location.href=\'/mypage/gauge.html\'" class="btn-primary">로비로 돌아가기</button></div>';
      return;
    }

    document.getElementById("roomTitleBar").textContent = room.title;
    document.getElementById("stepBadge").textContent = room.current_step;

    if (isAdmin) {
      var tci = document.getElementById("tableCountInput");
      if (tci && tci !== document.activeElement) tci.value = room.table_count;
      document.querySelectorAll(".step-btn").forEach(function(b) {
        b.className = b.dataset.step === room.current_step
          ? "step-btn text-xs px-3 py-2 rounded-lg border border-pink-400 text-pink-300 bg-pink-500/20 font-bold min-h-[36px]"
          : "step-btn text-xs px-3 py-2 rounded-lg border border-white/10 hover:border-pink-400 hover:text-pink-300 text-gray-500 transition min-h-[36px]";
      });
    }

    // 참여자 목록
    document.getElementById("memberCount").textContent = members.length;
    var ml = document.getElementById("memberList");
    ml.innerHTML = members.map(function(m) {
      var gc = m.gender === "M" ? "text-blue-400" : "text-pink-400";
      var tableInfo = m.table_no ? " T" + m.table_no : "";
      var nick = m.nickname ? ' "' + esc(m.nickname) + '"' : "";
      var kick = isAdmin ? ' <button onclick="kickMember(' + m.member_seq + ')" class="text-xs text-red-400 hover:text-red-300">거절</button>' : "";
      return '<div class="member-card flex items-center justify-between text-sm">'
        + '<span><span class="' + gc + '">[' + m.gender + ']</span> ' + esc(m.name)
        + '<span class="text-gray-500">' + tableInfo + nick + '</span></span>' + kick + '</div>';
    }).join("");

    // 단계별 UI 렌더링
    var stepChanged = (lastStep !== room.current_step);
    lastStep = room.current_step;
    loadStepUI(room, myMember, members, stepChanged);
  }

  // 단계별 HTML 로드
  var stepCache = {};
  async function loadStepUI(room, myMember, members, stepChanged) {
    var step = room.current_step;
    var el = document.getElementById("stepContent");

    // 각 단계의 render 함수 호출
    if (window["render_" + step]) {
      window["render_" + step](el, room, myMember, members, isAdmin, headers, roomId, stepChanged);
      return;
    }

    // 단계별 JS 파일 로드
    var scriptPath = "/mypage/gauge_steps/" + step.toLowerCase() + ".js";
    if (!stepCache[step]) {
      try {
        var script = document.createElement("script");
        script.src = scriptPath;
        script.onload = function() {
          stepCache[step] = true;
          if (window["render_" + step]) {
            window["render_" + step](el, room, myMember, members, isAdmin, headers, roomId, stepChanged);
          }
        };
        script.onerror = function() {
          el.innerHTML = '<div class="text-center py-12 card p-6"><div class="text-xl font-bold mb-2">' + esc(step) + '</div><p class="text-gray-400">게임이 진행 중입니다.</p></div>';
        };
        document.body.appendChild(script);
      } catch(e) {
        el.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">로딩 오류</p></div>';
      }
    } else {
      if (window["render_" + step]) {
        window["render_" + step](el, room, myMember, members, isAdmin, headers, roomId, stepChanged);
      }
    }
  }

  window.kickMember = async function(memberSeq) {
    if (!confirm("이 참여자를 거절하시겠습니까?")) return;
    try {
      var res = await fetch("/api/gauge/room/" + roomId + "/kick/" + memberSeq, { method: "POST", headers: headers });
      if (res.ok) {
        alert("참여자가 거절되었습니다.");
      } else {
        var d = await res.json();
        alert(d.error || "거절 처리에 실패했습니다.");
      }
    } catch(e) {
      alert("서버 오류가 발생했습니다.");
    }
    pollRoom();
  };

  // 공용 유틸리티
  window.gaugeUtil = {
    esc: esc,
    headers: headers,
    roomId: roomId,
    isAdmin: isAdmin,
    pollRoom: pollRoom
  };

  initRoom();
})();
</script>

</body>
</html>
